<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static',filename='bootstrap-icons/font/bootstrap-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='pagination.css') }}">
    <script src="{{ url_for('static',filename='pagination.min.js') }}"></script>

    <title>Align words</title>
    <style>
        .word {
            font-weight: bold;
            padding: 3px;
        }

        .highlight {
            background-color: yellow;
        }

        .hicell {
            background-color: lightgray;
        }

        .wordhi {
            color: red;
        }

        td {
            width: 3em;
            text-align: center;
        }

        table {
            margin: auto;
        }
    </style>

</head>
<body>
<div class="container">
    <h1 class="m-5">{{ name }}</h1>
    <a href="/">Powrót</a>
    <a href="/highlight" class="float-end">Podświetlanie</a>
</div>
<div class="container mb-5 p-5 card">
    <p>Zdanie:</p>
    <div id="sentences"></div>
    <p class="mt-3">Metody:</p>
    <div id="methods"></div>
</div>
<div class="position-relative">
    <img id="icon" src="{{ url_for('static',filename='unicorn.jpg') }}"
         class="position-absolute start-50 top-50 translate-middle d-none">
    <div id="container">
        <div class="container p-5">Wybierz zdanie i metodę...</div>
    </div>
</div>
<div class="container">
    <button class="btn btn-success form-control mt-5" id="save">Save</button>
</div>
<script>
    let flip = '{{ name }}'.startsWith('PL');
    let text_to, text_from;
    let from = [];
    let to = [];
    let ali = [];
    let from_num = 0;
    let to_num = 0;

    let hiwords = localStorage.getItem('wordlist');
    if (hiwords) {
        hiwords = new Set(hiwords.split('\n'));
    } else {
        hiwords = new Set();
    }

   let ali_counter=0;

    function refreshAli() {
        let method = $('input[name="method"]:checked')
        if (!method[0])
            return;
        method = $('label[for="' + method[0].id + '"]').text();
        let i = $('input[name="sentence"]:checked');
        if (!i[0])
            return;
        i = Number($('label[for="' + i[0].id + '"]').text());

        if (i >= 0 && method.length > 0) {
            $('#container').empty();
	    ali_counter+=1;
	    let local_counter=ali_counter;
            $.getJSON('/ali/{{ name }}/' + method, function (data) {
		if(ali_counter>local_counter)
		    return;
                load(text_from[i], text_to[i], data[i]);
            }).fail(function () {
                load(text_from[i], text_to[i], []);
            });
        }
    }

    $('#save').on('click', function () {
        $('#icon').removeClass('d-none');
        $('#icon').animate({
            width: '200%',
            height: '200%',
            opacity: 0.2
        }, 'slow', function () {
            $(this).removeAttr('style');
            $(this).addClass('d-none');
        });
        let i = $('input[name="sentence"]:checked');
        if (!i[0])
            return;
        si = Number($('label[for="' + i[0].id + '"]').text());
        let data = [];

        function send_data(data) {
            for (let i = 0; i < ali.length; i++)
                for (let j = 0; j < ali[i].length; j++)
                    if (ali[i][j].prop('checked')) {
                        data[si].push([j, i]);
                    }
            $.ajax({
                type: 'POST',
                url: '/save/{{ name }}',
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            });
        }

        $.getJSON('/ali/{{ name }}/Saved', function (data) {
            data[si] = [];
            send_data(data);
        }).fail(function () {
            let data = [];
            $.each(text_to, function (e) {
                data.push([])
            });
            console.log(data);
            send_data(data);
        });
    })
    ;

    $.getJSON('/text/{{ name }}', function (data) {
        if (flip) {
            text_from = data['pl']
            text_to = data['en'];
        } else {
            text_from = data['en']
            text_to = data['pl'];
        }
        for (let i = 0; i < text_from.length; i++) {
            let sb = $('<input type="radio" class="btn-check sc" name="sentence" id="sent' + i + '">' +
                '<label class="btn btn-outline-primary m-1" for="sent' + i + '">' + i + '</label>');
            sb.on('click', refreshAli);
            $('#sentences').append(sb);
        }
        $.getJSON('/methods/{{ name }}', function (data) {
            let mb = $('<input type="radio" class="btn-check mc" name="method" id="method_saved" checked>' +
                '<label class="btn btn-outline-success m-1" for="method_saved">Saved</label>');
            mb.on('click', refreshAli);
            $('#methods').append(mb);
            $.each(data, function (i, method) {
                if (method === 'Saved')
                    return;
                let mb = $('<input type="radio" class="btn-check mc" name="method" id="method' + i + '">' +
                    '<label class="btn btn-outline-primary m-1" for="method' + i + '">' + method + '</label>');
                mb.on('click', refreshAli);
                $('#methods').append(mb);
            });
        });
    });

    function hover(from_to, idx) {
        if (from_to) {
            for (let i = 0; i < from_num; i++)
                from[i].removeClass('highlight');
            from[idx].addClass('highlight');
            for (let i = 0; i < to_num; i++)
                if (ali[i][idx].prop('checked')) {
                    to[i].addClass('highlight');
                } else {
                    to[i].removeClass('highlight');
                }
        } else {
            for (let i = 0; i < to_num; i++)
                to[i].removeClass('highlight');
            to[idx].addClass('highlight');
            for (let i = 0; i < from_num; i++)
                if (ali[idx][i].prop('checked')) {
                    from[i].addClass('highlight');
                } else {
                    from[i].removeClass('highlight');
                }
        }
    }

    function load(from_text, to_text, ali_list) {
        $('#container').empty();
        let table = $('<table>');
        $('#container').append(table);
        let row = $('<tr>');
        table.append(row);
        from = [];
        ali = [];
        let hicol = [];
        from_text.trim().split(' ').forEach(function (el, i) {
            let word = $('<td class="word" id="f' + i + '">' + el + '</td>');
            let lel = el.toLowerCase().replaceAll(/\W/g, '').trim();
            if (hiwords.has(lel)) {
                word.addClass('wordhi');
                hicol.push(true);
            } else {
                hicol.push(false);
            }
            word.on('mouseenter', function () {
                hover(true, i);
            });
            row.append(word);
            from.push(word);
        });

        from_num = from.length;
        to = [];
        to_text.trim().split(' ').forEach(function (el, i) {
            let lel = el.toLowerCase().replaceAll(/\W/g, '').trim();
            let hirow = hiwords.has(lel);
            let row = $('<tr>');
            table.append(row);
            let ali_row = [];
            for (let i = 0; i < from_num; i++) {
                let ali_cell = $('<input type="checkbox">');
                let c = $('<td>');
                if (hirow || hicol[i])
                    c.addClass('hicell');
                c.append(ali_cell);
                row.append(c);
                ali_row.push(ali_cell);
            }
            ali.push(ali_row);
            let word = $('<span class="word" id="t' + i + '">' + el + '</span>');
            if (hirow)
                word.addClass('wordhi');
            word.on('mouseenter', function () {
                hover(true, i);
            });
            word.on('mouseenter', function () {
                hover(false, i);
            });
            row.append(word);
            to.push(word);
        });
        to_num = to.length;
        ali_list.forEach(function (el, i) {
            let fi, ti;
            if (flip) {
                fi = el[1];
                ti = el[0];
            } else {
                fi = el[0];
                ti = el[1];
            }
            ali[ti][fi].prop('checked', true);
        });
    }
</script>
</body>
</html>
